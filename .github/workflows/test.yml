name: Test Suite

on:
  push:
    branches: [ "*" ]
jobs:
  python-tests:
    name: Python Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 
      uses: actions/setup-python@v6
      with:
          python-version-file: "pyproject.toml"

    - name: Install uv
      uses: astral-sh/setup-uv@v6

    - name: Set up Docker (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        # Docker is pre-installed on ubuntu-latest
        docker --version

    - name: Set up Docker (macOS)
      if: runner.os == 'macOS'
      run: |
        # Install Docker Desktop for macOS
        brew install --cask docker
        # Start Docker Desktop
        open -a Docker
        # Wait for Docker to be ready
        while ! docker system info > /dev/null 2>&1; do sleep 1; done
        docker --version

    - name: Set up Docker (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        # Install Docker Desktop for Windows
        choco install docker-desktop -y
        # Start Docker service
        Start-Service docker
        # Wait for Docker to be ready
        $timeout = 300
        $elapsed = 0
        while ($elapsed -lt $timeout) {
          try {
            docker version
            break
          } catch {
            Start-Sleep -Seconds 5
            $elapsed += 5
          }
        }
        docker --version

    - name: Run checkhealth
      run: |
        uv run jpamb -vv checkhealth
    
    - name: Run build
      run: |
        uv run jpamb -vv build
        
        # Check if something was changed
        git diff --exit-code

    - name: Run Python tests 
      run: |
        uv run pytest test/
    

